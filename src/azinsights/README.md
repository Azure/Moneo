Azure Application Insights
==========================

Description
-----------
[Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) is a part of Azure Monitor that is traditionally used for monitoring web apps. However, it can also be used as an alternative to Grafana for visualization of GPU and InfiniBand (IB) metrics. 

Prerequisites
-------------
- [Azure Subscription](https://azure.microsoft.com/en-us/free/search/?OCID=AIDcmm5edswduu_SEM_42cfb6241b0210cccb1bd4c6a446df9b:G:s&ef_id=42cfb6241b0210cccb1bd4c6a446df9b:G:s&msclkid=42cfb6241b0210cccb1bd4c6a446df9b)
- [Application Insights resource](https://docs.microsoft.com/en-us/azure/azure-monitor/app/create-new-resource)

To create a new Application Insights resource from Azure CLI, you can use:
```sh
New-AzApplicationInsights [-ResourceGroupName] <String> [-Name] <String> [-Location] <String> [-Kind <String>][-Tag <Hashtable>] [-DefaultProfile <IAzureContextContainer>] [-WhatIf] [-Confirm] [<CommonParameters>]
```

Configuration
-------------
Prepare a config file `config.ini` in the Moneo directory, here's an example:

```ini
[azure]
instrumentation_key = InstrumentationKey=<your-instrumentation_key>
subscription_id =<your-subscription_id>
resource_group =<your-resource_group> 
application_insights =<your-application_insights> 

[prometheus]
base_url = http://localhost:9090
```
**Note**: for the metrics to be properly exported to Application Insights, the only two required fields are the instrumentation key and the base url for the Prometheus Database resource. The others can be used alongside [dashboard_config.py](./dashboard_config.py) to customize templates for the creation of Dashboards in Azure Portal. 

Additionally, the instrumentation key, subscription id, resource group, and application insights can be found in your Application Insights overview as shown below: 
![image](https://user-images.githubusercontent.com/71988295/181628840-ee7a8ee9-941b-4c45-a372-d1a8d45bb02e.png)

Usage
-----
### _Deployment_
Use the -i or --insights flag alongside the Moneo deployment command to start exporting to Azure Insights. For example,
```sh
# deploy Moneo fully and export metrics to Application Insights 
python3 moneo.py -d -i
```

### _Shutdown_
The shutdown process is unchanged. For example,
```sh
# shuts down Moneo fully and stops exporting metrics to Application Insights 
python3 moneo.py -s
```

Viewing Metrics on Azure Portal
-------------------------------
### _Individual Metrics_
While on your Application Insights resource associated with the instrumentation key in the config file, on the left panel, select **Metrics** under **Monitoring**. The **Scope** should by default be your Application Insights resource. For best results, select the metric name you would like to visualize for both the **Metric Namespace** and the **Metric** itself. Finally, consider filtering or splitting the graph by job id, VM instance, or GPU Index/IB Port. For more information on filtering vs. splitting, take  a look at these [examples](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/metrics-aggregation-explained) under "Dimensions, splitting, and filtering".         

### _Setting up the Dashboards_
Coming soon.

1. Device Counters Dashboard:
![DeviceDashboard](https://user-images.githubusercontent.com/71988295/184216568-5927f3fe-c5ef-4394-884f-edce1be7a956.PNG)

2. Profiling Counters Dashboard:
![ProfilingDashboard](https://user-images.githubusercontent.com/71988295/184216605-c5bf5dfa-ffff-4773-a4ad-3cd029aa4234.PNG)

3. InfiniBand Network Counters Dashboard:
![InfiniBandDashboard](https://user-images.githubusercontent.com/71988295/184216626-93825f28-885b-4326-9195-662fb90152e2.PNG)

Exporting of Additional Metrics
-------------------------------
### _DCGM or IB Metrics_
Go through the following steps:
- Granted that they are already available through the Prometheus Database resource, add their names to the corresponding list at the top of [PrometheusMetricExporter.py](collector/PrometheusMetricCollector.py). 
- Add the metric names, their description, unit, and type to [metric_info.json](./metric_info.json) in the format provided.

### _Other Metric Types_
Go through the following steps:
- Create an additional list at the top of [PrometheusMetricExporter.py](collector/PrometheusMetricCollector.py) including the metric names exactly as they are exposed in the Prometheus Database resource.
- Create an organizer that is a subclass of [MetricOrganizer.py](organizer/MetricOrganizer.py) that properly formats data from the http response generated by querying the Prometheus Database. Add it to [MetricOrganizerFactory.py](organizer/MetricOrganizerFactory.py).
- In [PrometheusMetricExporter.py](collector/PrometheusMetricCollector.py)'s ```collect_metrics``` method, create an instance of your MetricOrganizer using MetricOrganizerFactory and pass it and the list of metrics you created to the ```collect_metrics_of_type``` method.
- Add the metric names, their description, unit, and type to [metric_info.json](./metric_info.json) in the format provided.
- In [ApplicationInsightsExporter.py](exporter/ApplicationInsightsExporter.py), create a ```register_<metric_type>_view``` method and add it to the options in the ```register_view``` method.

If you have questions about any of the previous steps, it may be worth looking at [DCGMMetricOrganizer.py](organizer/DCGMMetricOrganizer.py) and the other mentioned files as to how they relate to the collection and exportation of DCGM metrics.  

